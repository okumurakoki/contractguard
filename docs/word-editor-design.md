# Word風編集機能 設計書

## 概要
契約書詳細ページで、PDF形式の契約書をWord風のエディタで直接編集できる機能

## 主な機能要件

### 1. エディタコンポーネント
- リッチテキストエディタ（Lexical / Tiptap / Draft.jsなどを使用）
- PDFから抽出したテキストを編集可能にする
- Word風のツールバー UI

### 2. 編集機能
- **テキスト編集**: 段落の追加・削除・修正
- **書式設定**:
  - フォント: サイズ、太字、斜体、下線
  - 段落: 左寄せ、中央、右寄せ、両端揃え
  - リスト: 箇条書き、番号付きリスト
  - インデント調整
- **条項番号の自動調整**:
  - 条項を追加・削除した際に自動で番号を振り直す
  - 第1条、第2条... の形式に対応
  - (1), (2), ... などのサブ番号にも対応

### 3. PDF連携
- PDF.jsでPDFを読み込み
- テキスト抽出（pdfjs-dist使用）
- 編集後にPDF再生成（jsPDF + html2pdfなど）

### 4. UI構成

```
┌─────────────────────────────────────────────┐
│  [戻る] 契約書名                     [保存]  │
├─────────────────────────────────────────────┤
│  ツールバー                                  │
│  [B] [I] [U] | [左] [中] [右] | [リスト]    │
├──────────────┬──────────────────────────────┤
│              │                              │
│  目次        │  エディタエリア               │
│  第1条       │  ┌──────────────────────┐   │
│  第2条       │  │ 編集可能なテキスト    │   │
│  第3条       │  │                      │   │
│  ...         │  │                      │   │
│              │  └──────────────────────┘   │
│              │                              │
└──────────────┴──────────────────────────────┘
```

### 5. 技術スタック候補

#### オプション1: Lexical (Meta製)
- メリット: モダン、拡張性が高い、型安全
- デメリット: 比較的新しい、学習コスト

#### オプション2: Tiptap (推奨)
- メリット: 簡単、豊富なプラグイン、ドキュメント充実
- デメリット: 商用利用は有料版推奨

#### オプション3: Draft.js
- メリット: 実績豊富、安定している
- デメリット: やや古い、開発が停滞気味

### 6. 実装ステップ

#### Step 1: PDF表示・テキスト抽出
- PDF.jsでPDFを読み込み
- テキストレイヤーを抽出
- プレーンテキストとして保存

#### Step 2: エディタ実装
- Tiptapエディタをセットアップ
- 基本的な編集機能（テキスト、書式）
- ツールバーUI実装

#### Step 3: 条項番号管理
- 条項の自動検出（正規表現）
- 番号の自動振り直しロジック
- 条項追加・削除のUI

#### Step 4: 保存・エクスポート
- 編集内容の保存（JSON形式）
- PDFへの再変換
- バージョン履歴管理

### 7. データ構造

```typescript
interface EditableContract {
  id: string;
  originalPdfUrl: string;
  extractedText: string;
  editableContent: JSONContent; // Tiptapのフォーマット
  articles: Article[];
  lastModified: Date;
  version: number;
}

interface Article {
  number: number;
  title: string;
  content: string;
  subArticles?: SubArticle[];
}

interface SubArticle {
  number: number;
  content: string;
}
```

### 8. 将来的な拡張

- AIによる自動条項提案
- 変更履歴のトラッキング
- 複数人での同時編集（リアルタイムコラボレーション）
- 条項のテンプレート化
- 差分表示（元のPDFとの比較）

## 技術的な課題

1. **PDF→テキスト変換の精度**
   - レイアウトの維持が難しい
   - 表組みや複雑なフォーマットの処理

2. **条項番号の自動調整**
   - 様々な番号形式への対応
   - ネストした番号の処理

3. **PDF再生成時の品質**
   - フォント、レイアウトの再現
   - ファイルサイズの最適化

## 推奨ライブラリ

```json
{
  "@tiptap/react": "^2.x",
  "@tiptap/starter-kit": "^2.x",
  "@tiptap/extension-text-align": "^2.x",
  "@tiptap/extension-underline": "^2.x",
  "pdfjs-dist": "^3.x",
  "jspdf": "^2.x",
  "html2pdf.js": "^0.10.x"
}
```

## 実装優先度

Phase 3での実装を推奨:
1. PDF表示とテキスト抽出 (1-2日)
2. 基本的なエディタ機能 (2-3日)
3. 条項番号管理 (2-3日)
4. 保存・エクスポート (1-2日)

合計: 約1-2週間の開発期間を想定
