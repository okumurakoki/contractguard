// ContractGuard Prisma Schema
// AI契約書レビューSaaS

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// 組織管理
// ============================================================

model Organization {
  id              String    @id @default(uuid())
  name            String
  planType        String    @default("lite") // lite, standard, premium, enterprise
  industry        String?
  employeeCount   Int?

  // 自社情報（署名欄用）
  companyAddress        String?   // 住所
  companyRepresentative String?   // 代表者名
  companyRepTitle       String?   // 代表者肩書（代表取締役など）

  // サブスクリプション
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?  @unique
  trialEndsAt          DateTime?
  subscriptionStatus   String?  // active, canceled, past_due

  // 請求
  billingEmail    String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  users           User[]
  contracts       Contract[]
  templates       Template[]
  folders         Folder[]
  consultations   LawyerConsultation[]
  auditLogs       AuditLog[]
  invitations     Invitation[]
  counterparties  Counterparty[]

  @@index([planType])
}

// ============================================================
// 取引先管理
// ============================================================

model Counterparty {
  id              String    @id @default(uuid())
  organizationId  String

  // 基本情報
  name            String    // 会社名
  shortName       String?   // 略称
  address         String?   // 住所
  representative  String?   // 代表者名
  repTitle        String?   // 代表者肩書（代表取締役など）

  // 連絡先
  email           String?
  phone           String?

  // 分類
  category        String?   // 顧客、仕入先、パートナーなど
  notes           String?   @db.Text

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contracts       Contract[]

  @@index([organizationId])
  @@index([name])
}

// ============================================================
// ユーザー管理
// ============================================================

model User {
  id             String    @id // Clerk user ID
  organizationId String
  email          String    @unique
  name           String?
  role           String    @default("editor") // admin, editor, viewer
  authProvider   String?   // email, google, microsoft

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  uploadedContracts Contract[] @relation("UploadedBy")
  auditLogs         AuditLog[]
  consultations     LawyerConsultation[] @relation("RequestedBy")

  @@index([organizationId])
  @@index([email])
}

// ============================================================
// 契約書管理
// ============================================================

model Contract {
  id              String    @id @default(uuid())
  organizationId  String
  uploadedBy      String

  // ファイル情報
  fileName        String
  filePath        String    // S3 key
  fileSize        Int?
  fileType        String?

  // 契約情報
  contractType    String?
  contractTitle   String?
  counterparty    String?   // 取引先名（旧フィールド、後方互換用）
  counterpartyId  String?   // 取引先マスタへの参照
  ourPosition     String?   // 自社の立場: kou(甲), otsu(乙)
  contractDate    DateTime?
  expiryDate      DateTime?
  autoRenewal     Boolean   @default(false)
  cancellationNoticeDays Int?

  // ステータス
  status          String    @default("analyzing") // analyzing, completed, archived

  // 編集済みコンテンツ（HTML）
  editedContent   String?   @db.Text

  // 構造化コンテンツ（JSON）
  structuredContent Json?

  // バージョン管理
  currentVersion  Int       @default(1)

  // タグ・フォルダ
  tags            String[]
  folderId        String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploadedByUser  User         @relation("UploadedBy", fields: [uploadedBy], references: [id])
  folder          Folder?      @relation(fields: [folderId], references: [id])
  counterpartyRef Counterparty? @relation(fields: [counterpartyId], references: [id])

  review          ContractReview?
  consultations   LawyerConsultation[]
  versions        ContractVersion[]

  @@index([organizationId])
  @@index([uploadedBy])
  @@index([contractType])
  @@index([status])
  @@index([expiryDate])
  @@index([folderId])
  @@index([counterpartyId])
}

// ============================================================
// 契約書バージョン管理
// ============================================================

model ContractVersion {
  id              String    @id @default(uuid())
  contractId      String
  versionNumber   Int
  content         String    @db.Text
  createdBy       String
  createdAt       DateTime  @default(now())
  changesSummary  String?   @db.Text

  contract        Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@unique([contractId, versionNumber])
  @@index([contractId])
  @@index([createdAt])
}

// ============================================================
// レビュー結果
// ============================================================

model ContractReview {
  id               String   @id @default(uuid())
  contractId       String   @unique

  // 分析結果
  riskLevel        String   // high, medium, low
  overallScore     Int?     // 0-100

  // リスク詳細（JSON）
  risks            Json?

  // チェックリスト
  checklist        Json?

  // AI使用モデル
  aiModel          String?
  analysisDuration Int?     // 秒

  createdAt        DateTime @default(now())

  contract         Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  riskItems        RiskItem[]

  @@index([contractId])
  @@index([riskLevel])
}

model RiskItem {
  id            String   @id @default(uuid())
  reviewId      String

  riskType      String   // 損害賠償、解除条件、遅延損害金 etc.
  riskLevel     String   // high, medium, low

  // 該当箇所（構造化データ対応）
  articleNumber   Int?     // 第X条の番号
  paragraphNumber Int?     // 項番号
  articleId       String?  // 条項のUUID
  pageNumber      Int?
  sectionTitle    String?
  originalText    String?  @db.Text

  // 修正案
  suggestedText String?  @db.Text
  reason        String?  @db.Text
  legalBasis    String?  @db.Text

  // ユーザーアクション
  userAction    String   @default("pending") // accepted, rejected, pending
  userComment   String?  @db.Text

  createdAt     DateTime @default(now())

  review        ContractReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([riskLevel])
}

// ============================================================
// テンプレート
// ============================================================

model Template {
  id              String   @id @default(uuid())
  organizationId  String?  // NULL = 公式テンプレート
  createdBy       String?

  title           String
  description     String?  @db.Text
  category        String   // 業務委託、NDA etc.
  industry        String?  // 建設、IT etc.

  content         String   @db.Text
  variables       Json?    // 可変項目定義

  isPublic        Boolean  @default(false)
  isPremium       Boolean  @default(false)
  price           Int?

  usageCount      Int      @default(0)
  rating          Float?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([industry])
  @@index([isPublic])
  @@index([isPremium])
}

// ============================================================
// フォルダ管理
// ============================================================

model Folder {
  id              String   @id @default(uuid())
  organizationId  String
  parentFolderId  String?

  name            String
  color           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentFolder    Folder?      @relation("FolderHierarchy", fields: [parentFolderId], references: [id])
  childFolders    Folder[]     @relation("FolderHierarchy")

  contracts       Contract[]

  @@index([organizationId])
  @@index([parentFolderId])
}

// ============================================================
// 弁護士マスタ
// ============================================================

model Lawyer {
  id              String   @id @default(uuid())
  name            String
  email           String   @unique
  phone           String?

  // プロフィール
  imageUrl        String?
  bio             String?  @db.Text
  yearsOfExperience Int?

  // 専門分野（複数可）
  specializations String[]  // 契約法、労働法、知財 etc.

  // 資格・所属
  barNumber       String?   // 弁護士登録番号
  lawFirm         String?   // 所属事務所
  prefecture      String?   // 所在地

  // 料金
  hourlyRate      Int?      // 時給（円）
  consultationFee Int?      // 初回相談料（円）

  // 評価
  rating          Float     @default(0)
  reviewCount     Int       @default(0)

  // ステータス
  isActive        Boolean   @default(true)
  isVerified      Boolean   @default(false)

  // 対応可能な相談タイプ
  availableTypes  String[]  // chat, video, review

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  consultations   LawyerConsultation[]
  availabilities  LawyerAvailability[]
  reviews         LawyerReview[]

  @@index([isActive])
  @@index([rating])
  @@index([specializations])
}

// ============================================================
// 弁護士のスケジュール
// ============================================================

model LawyerAvailability {
  id              String   @id @default(uuid())
  lawyerId        String

  dayOfWeek       Int      // 0-6 (日-土)
  startTime       String   // "09:00"
  endTime         String   // "18:00"

  // 特定日の設定（繰り返しではなく特定日）
  specificDate    DateTime?
  isAvailable     Boolean  @default(true)

  createdAt       DateTime @default(now())

  lawyer          Lawyer   @relation(fields: [lawyerId], references: [id], onDelete: Cascade)

  @@index([lawyerId])
  @@index([dayOfWeek])
  @@index([specificDate])
}

// ============================================================
// 弁護士レビュー
// ============================================================

model LawyerReview {
  id              String   @id @default(uuid())
  lawyerId        String
  consultationId  String   @unique

  rating          Int      // 1-5
  comment         String?  @db.Text

  isAnonymous     Boolean  @default(false)

  createdAt       DateTime @default(now())

  lawyer          Lawyer   @relation(fields: [lawyerId], references: [id], onDelete: Cascade)
  consultation    LawyerConsultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  @@index([lawyerId])
  @@index([rating])
}

// ============================================================
// 弁護士相談
// ============================================================

model LawyerConsultation {
  id              String    @id @default(uuid())
  contractId      String?
  organizationId  String
  requestedBy     String

  lawyerId        String?
  consultationType String   // chat, video, review

  status          String    @default("pending") // pending, in_progress, completed

  estimatedFee    Int?
  actualFee       Int?
  paymentStatus   String?   // unpaid, paid, refunded
  stripePaymentId String?

  requestDetails  String?   @db.Text
  lawyerResponse  String?   @db.Text

  scheduledAt     DateTime?
  completedAt     DateTime?

  createdAt       DateTime  @default(now())

  contract        Contract?      @relation(fields: [contractId], references: [id])
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requestedByUser User           @relation("RequestedBy", fields: [requestedBy], references: [id])
  lawyer          Lawyer?        @relation(fields: [lawyerId], references: [id])
  review          LawyerReview?

  @@index([organizationId])
  @@index([requestedBy])
  @@index([status])
  @@index([lawyerId])
}

// ============================================================
// 監査ログ
// ============================================================

model AuditLog {
  id            String   @id @default(uuid())
  organizationId String
  userId        String

  action        String   // create, update, delete, view, download, analyze, invite
  resourceType  String   // contract, template, folder, user, invitation
  resourceId    String?

  ipAddress     String?
  userAgent     String?  @db.Text
  metadata      String?  @db.Text  // JSON形式の追加情報

  createdAt     DateTime @default(now())

  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
}

// ============================================================
// 招待管理
// ============================================================

model Invitation {
  id             String   @id @default(uuid())
  organizationId String
  email          String
  role           String
  token          String   @unique
  expiresAt      DateTime
  acceptedAt     DateTime?

  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
  @@index([organizationId])
}
